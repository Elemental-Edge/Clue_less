import requests
import json

SERVER_URL = "http://127.0.0.1:8000/"  # Replace with your Django server URL

def register(username, password):

    # Step 1: Send a GET request to retrieve the CSRF token
    get_response = requests.get(f"{SERVER_URL}/register/")  # Adjust the URL as needed
    csrf_token = get_response.json().get('csrfToken')  # Extract the CSRF token from the response

    print(f"CSRF Token: {csrf_token}")  # Optional: Print the CSRF token for verification

    # Step 2: Prepare to make the POST request with the CSRF token
    data = {
        'username': username,
        'password1': password,
        'password2': password,
    }

    # Include the CSRF token in the headers for the POST request
    headers = {
        'X-CSRFToken': csrf_token,  # Set the CSRF token in the headers
    }

    # Make the POST request to register the user
    post_response = requests.post(f"{SERVER_URL}/register/", data=data, cookies=get_response.cookies, headers=headers)

    print(post_response.json())  # Print the response from the server
    """requests.
    print(f"Registering username {username} and password {password}")
    response = requests.post(f"{SERVER_URL}/register/", data={'username': username, 'password': password})
    print(response.json())"""

def login(username, password):
    response = requests.post(f"{SERVER_URL}/login/", data={'username': username, 'password': password})
    print(response.json())
    return response.cookies  # Store cookies for authenticated requests

def send_message(cookies, content):
    response = requests.post(f"{SERVER_URL}/messages/", data={'content': content}, cookies=cookies)
    print(response.json())

def get_messages():
    response = requests.get(f"{SERVER_URL}/messages/")
    messages = response.json().get('messages', [])
    for msg in messages:
        print(f"{msg['sender']}: {msg['content']}")




"""
# Step 1: Get the CSRF token
response = requests.get(f"{SERVER_URL}/register/")  # Adjust the URL as needed
csrf_token = response.cookies['csrftoken']  # Get the CSRF token from cookies

# Step 2: Make the POST request with the CSRF token
data = {
    'username': 'your_username',
    'password': 'your_password',
}

headers = {
    'X-CSRFToken': csrf_token,  # Include the CSRF token
}

post_response = requests.post('http://your-server-url/register/', data=data, cookies=response.cookies, headers=headers)

print(post_response.text)  # Check the response from the server

"""




def main():
    print("Welcome to the Clue Game Client!")
    username = input("Enter your username: ")
    password = input("Enter your password: ")

    # Register user
    register(username, password)

    # Login user
    cookies = login(username, password)

    while True:
        action = input("Enter 'send' to send a message, 'get' to retrieve messages, or 'exit' to quit: ")

        if action == 'send':
            content = input("Enter your message: ")
            send_message(cookies, content)
        elif action == 'get':
            get_messages()
        elif action == 'exit':
            break
        else:
            print("Invalid action. Please try again.")

if __name__ == "__main__":
    main()